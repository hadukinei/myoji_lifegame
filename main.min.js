(()=>{let e=()=>{document.querySelector("aside#mask").dataset.state="visible"},t=()=>{document.querySelector("aside#mask").dataset.state="hidden"};const r=1,o=2,a=3,n=4,d=5;let c=(e,t,l)=>{let c,i=document.createElement("dd"),u=document.querySelector("#generation").innerHTML;switch(e){case r:c=document.createTextNode("【決着】"+l+" 家が第 "+u+" 世代で名字を統一しました");break;case a:c=document.createTextNode("["+u+"] "+l+" さん出産を報告");break;case d:c=document.createTextNode("["+u+"] "+l+" 家が断絶");break;case o:case n:default:return void(i=null)}i.appendChild(c),i.dataset.id=t,i.dataset.mode=e,document.querySelector("section#table dl").insertBefore(i,document.querySelector("section#table dl").firstChild),i=null},u=()=>{e(),setTimeout(()=>{if(Array.from(new Map(Array.from(document.querySelectorAll("section#table ol li")).map(e=>[e.dataset.id,0]))).length<2){let e=document.querySelector("section#table ol li").dataset.id,l=document.querySelector('#table ul li[data-id="'+e+'"] span').innerHTML;if(c(r,e,l),document.querySelectorAll('#table dl dd[data-mode="3"]').length){let e=0;for(let t=0,l=document.querySelectorAll("#table dl dd"),r=l.length;t<r&&l[t]!==Array.from(document.querySelectorAll('#table dl dd[data-mode="3"]')).pop();t++)e++;document.querySelectorAll("#table dd:nth-of-type(n+"+(e+3)+")").forEach(e=>{e.innerHTML=e.innerHTML.replace(" 家が断絶","家")})}else document.querySelectorAll("#table dl dd:not(:nth-of-type(-n+3))").forEach(e=>{e.innerHTML=e.innerHTML.replace(" 家が断絶","家")});return document.querySelector("main").dataset.state="pause",void t()}if("pausing"===document.querySelector("main").dataset.state)return document.querySelector("main").dataset.state="pause",void t();if(document.querySelector("main").dataset.state="playing",document.querySelectorAll("section#table ol li").length%2==1){let e=document.querySelector("section#table ol li:last-of-type").dataset.id,t=document.querySelector('#table ul li[data-id="'+e+'"] span').innerHTML;c(o,e,t),document.querySelector("section#table ol").removeChild(document.querySelector("section#table ol li:last-of-type"))}let e=[];Array.from(document.querySelectorAll("section#table ol li")).sort(()=>~~(3*Math.random())-1).forEach(t=>{e.push(t)});let l=[],m=[];for(let t=0,r=e.length;t<r;t+=2){let r=0,o="";~~(2*Math.random())-0?(r=e[t].dataset.id,o=e[t].style.backgroundColor):(r=e[t+1].dataset.id,o=e[t+1].style.backgroundColor),e[t].dataset.id=r,e[t].style.backgroundColor=o,e[t+1]&&(e[t+1].dataset.id=r,e[t+1].style.backgroundColor=o),100*Math.random()<=.0315&&l.push({id:r,color:o}),100*Math.random()<=.129&&m.push({elm:e[t],id:r}),100*Math.random()<=.129&&m.push({elm:e[t+1],id:r})}l.forEach(t=>{let l=document.createElement("li");l.dataset.id=t.id,l.style.backgroundColor=t.color,e.push(l),document.querySelector("section#table ol").appendChild(l);let r=document.querySelector('#table ul li[data-id="'+t.id+'"] span').innerHTML;c(a,t.id,r),l=null}),m.forEach(t=>{e.splice(1),document.querySelector("section#table ol").removeChild(t.elm),t.elm=null;let l=document.querySelector('#table ul li[data-id="'+t.id+'"] span').innerHTML;c(n,t.id,l),li=null});let s=Array.from(new Map(Array.from(document.querySelectorAll("section#table ol li")).map(e=>[e.dataset.id,0])).keys()).sort();Array.from(document.querySelectorAll("section#table ul li")).filter(e=>"0"!==e.querySelector("small").innerHTML).map(e=>e.dataset.id).sort().filter(e=>!s.includes(e)).forEach(e=>{let t=document.querySelector('#table ul li[data-id="'+e+'"] span').innerHTML;c(d,e,t)}),e=null;let y=0,p=0;document.querySelectorAll("#table ul li").forEach(e=>{let t=document.querySelectorAll('section#table ol li[data-id="'+e.dataset.id+'"]').length;e.querySelector("small").innerHTML=t+"",e.dataset.tmpcnt=t+"",t>y&&(y=t),p+=t}),document.querySelectorAll("#table ul li").forEach(e=>{let t=~~((e.dataset.tmpcnt-0)/y*100);e.querySelector("meter").value=t+"",e.style.order=y-(e.dataset.tmpcnt-0)+"",e.removeAttribute("data-tmpcnt")});let h=document.querySelector("section#table ul");for(document.querySelectorAll("#table ul li").forEach(e=>{e.querySelector("small").innerHTML-0==0&&(e.removeChild(e.querySelector("data")),e.removeChild(e.querySelector("span")),e.removeChild(e.querySelector("small")),e.removeChild(e.querySelector("meter")),h.removeChild(e))}),h=null,h=document.querySelector("section#table dl"),i=document.querySelectorAll('section#table dd[data-mode="3"]').length-20;i>0;i--)h.removeChild(Array.from(h.querySelectorAll('dd[data-mode="3"]')).pop());h=null;let S=document.querySelector("#generation").innerHTML-0;document.querySelector("#generation").innerHTML=S+1+"",document.querySelector("#population").innerHTML=p+"","playing"===document.querySelector("main").dataset.state&&setTimeout(()=>{u()},150),t()},10)},m=()=>{document.querySelector("main").dataset.state="pausing"},s=()=>{e(),setTimeout(()=>{let e=document.querySelector("section#data textarea").value;if(!e)return t(),void alert("ERR_100: データが存在しません");let r=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n+/g,"\n").replace(/(^\n|\n$)/,"");if(!r)return t(),void alert("ERR_101: データが存在しません");for(let e=0,l=(r=r.split("\n")).length;e<l;e++){if(r[e]=r[e].split("\t"),2!==r[e].length)return t(),void alert("ERR_110: データの書式が正しくありません");if(""===r[e][0])return t(),void alert("ERR_111: データの名字が空欄です");if(""===r[e][1])return t(),void alert("ERR_112: データの件数が空欄です");if(/[^0-9]/.test(r[e][1]))return t(),void alert("ERR_113: データの件数に数字以外の文字が含まれています");r[e][0]=r[e][0]+"",r[e][1]=~~r[e][1],r[e][2]=e}let o=[],a=0;for(i=0,l=r.length;i<l;i++)a<r[i][1]&&(a=r[i][1]),o.push({id:r[i][2],name:r[i][0],count:r[i][1],color:"#"+(~~(255*Math.random())).toString(16).padStart(4,"0").substring(2,4)+(~~(255*Math.random())).toString(16).padStart(4,"0").substring(2,4)+(~~(255*Math.random())).toString(16).padStart(4,"0").substring(2,4)});let n=[];for(i=0,l=r.length;i<l;i++)for(let e=0,t=r[i][1];e<t;e++)n.push({id:r[i][2],name:r[i][0],value:~~(1e9*Math.random())});n.sort((e,t)=>e.value-t.value),0!==document.querySelectorAll("section#table ol li").length&&document.querySelectorAll("section#table ol li").forEach(e=>{e.parentNode.removeChild(e)}),0!==document.querySelectorAll("section#table dl dd").length&&document.querySelectorAll("section#table dl dd").forEach(e=>{e.parentNode.removeChild(e)}),0!==document.querySelectorAll("section#table ul li").length&&document.querySelectorAll("section#table ul li").forEach(e=>{e.parentNode.removeChild(e)});let d=document.querySelector("section#table ol");n.forEach(e=>{let t=document.createElement("li");d.appendChild(t),t.setAttribute("data-id",e.id);let l=o.filter(t=>t.id===e.id);0===l.length?t.style.backgroundColor="#0000":t.style.backgroundColor=l[0].color,t=null}),d=null,d=document.querySelector("section#table ul"),o.forEach(e=>{let t=document.createElement("li"),l=document.createElement("data"),r=document.createElement("span"),o=document.createTextNode(e.name),n=document.createElement("small"),c=document.createTextNode(e.count),i=document.createElement("meter"),u=~~(e.count/a*100);d.appendChild(t),t.appendChild(l),t.appendChild(r),r.appendChild(o),t.appendChild(n),n.appendChild(c),t.appendChild(i),t.setAttribute("data-id",e.id),l.style.backgroundColor=e.color,i.setAttribute("value",u),i.setAttribute("min",0),i.setAttribute("max",100),i.setAttribute("low",0),i.setAttribute("high",50),i.setAttribute("optimum",50),t=l=r=o=n=c=i=null}),d=null,document.querySelector("b#generation").innerHTML="1";let c=0;document.querySelectorAll("#table ul li").forEach(e=>{let t=document.querySelectorAll('section#table ol li[data-id="'+e.dataset.id+'"]').length;c+=t}),document.querySelector("#population").innerHTML=c+"",t()},10)};document.addEventListener("DOMContentLoaded",()=>{document.querySelector("button#start").addEventListener("click",u),document.querySelector("button#stop").addEventListener("click",m),document.querySelector("button#init").addEventListener("click",s);let e=document.querySelector("head"),t=document.createElement("link");e.appendChild(t),t.rel="stylesheet",t.href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@500&display=swap"})})();